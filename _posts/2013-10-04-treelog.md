---
layout: post
title: Treelog

meta:
  nav: blog
  author: channingwalton
  pygments: true
---

Treelog
=======

[Treelog](https://github.com/lancewalton/treelog) is the result of a real problem that arose in a trading system that we were working on: 
> how can we audit absolutely everything that happens to a trade as it travels through our system?

The first (and tedious) answer is copius logging of the form: `log.info("The trade was accepted.")`

There are a number of problems with this approach:

- writing logging in and around computations often complicates the code. Values must be extracted, recorded and then applied
- the decoupled nature of logging from the computation can lead to inaccurate logs
- linear logs are very difficult to follow
- its not easy to control how much of log to show a user if you do not know what is detail and what isn't

Treelog is an experiment to resolve these issues by applying a couple of ideas from the Typeclassopedia: the Writer Monad and a cunning Monoid.

Whats are Writers and Monoids
-----------------

There are a number of examples and explanations of the Writer (see the references below). But put simply, Learn You a Haskell states: 
> Writer allows us to do computations while making sure that all the log values are combined into one log value that then gets attached to the result.

Here is a simple example, see the references for more detailed examples.

```scala
val r: Writer[String, Int] = 
  for {
    a ← 3.set("Got a 3.")
    b ← 5.set("Got a 5.")
  } yield a * b

println(r.written) // Got a 3.Got a 5.
println(r.value) // 15
```
The Writer uses a monoid for the written value (a String in this case) to combine the logs (concatenate for String).

So whats a Monoid? 
> A Monoid is a type with an associative binary operation (append) and an identity value. 

For Strings that is concatenation and the empty String, for Lists its append and Nil, etc.

Back to Treelog
---------------

Treelog uses a [scalaz](http://typelevel.org/) Writer, [Tree](https://github.com/scalaz/scalaz/blob/master/core/src/main/scala/scalaz/Tree.scala) and a custom [Monoid](https://github.com/scalaz/scalaz/blob/master/core/src/main/scala/scalaz/Monoid.scala) implementation to record logs. Treelog also adds some extra syntax which I'll cover below, but the main ingredient is the Monoid implementation.

The Treelog monoid has to do two things, provide a `zero` value and a binary operation that combines two trees. 

The zero value for Treelog is just a constant used internally to the Monoid implementation and never leaks out since there is always at least one value being logged.

The append operation is more interesting since it needs to combine two Trees. 

Further Reading
===============

- [Writer Monad in Haskell](http://learnyouahaskell.com/for-a-few-monads-more)
- [Writer Monad in Scalaz](http://eed3si9n.com/learning-scalaz-day6)